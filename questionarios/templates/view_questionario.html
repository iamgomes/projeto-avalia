{% extends 'base.html' %}
{% load static %}

{% block 'title' %}Questionário{% endblock 'title' %}

{% block 'head' %}

        <!-- Lightbox css -->
        <link href="{% static 'assets/libs/magnific-popup/magnific-popup.css' %}" rel="stylesheet" type="text/css" />
        <link href="{% static 'css/app.css' %}" rel="stylesheet">

{% endblock 'head' %}


{% block 'body' %}

{% if messages %}
    {% for message in messages  %}
        <div class="alert {{message.tags}} alert-dismissible fade show" role="alert">
            <i class="mdi mdi-bullseye-arrow me-2"></i>
            {{message}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-xl-4">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-4">Tramitação</h4>
                <ol class="activity-feed">
                    {% for t in tramitacao %}
                    <li class="feed-item">
                        <div class="feed-item-list">
                            <span class="date">{{ t.created_at }}</span>
                            <h6>{{ t.get_setor_display }}</h6>
                            <span class="activity-text">{{ t.get_motivo_display }}</span>
                            <footer class="blockquote-footer font-size-12 m-0">
                                {{ t.usuario.first_name }}
                                {% if t.observacao %}
                                <i style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#Observacao-{{t.id}}" 
                                class="mdi mdi-comment-text font-size-18" data-toggle="tooltip" title="Observação"></i>
                                {% endif %}
                            </footer>
                           
                            <!--Modal-->
                            {% include 'modal_observacao.html' %}

                        </div>
                    </li>
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>

    <div class="col-xl-8">
        <div class="card">
            <div class="card-body">
                <div class="float-end d-none d-md-inline-block">
                    <div class="dropdown card-header-dropdown">
                        <a class="text-reset dropdown-btn" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="text-muted"><i class="mdi mdi-file-export-outline me-1"></i>Exportar<i class="mdi mdi-chevron-down ms-1"></i></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="#">PDF</a>
                            <a class="dropdown-item" href="#">Excel</a>
                            <a class="dropdown-item" href="#">CSV</a>
                        </div>
                    </div>
                </div>

                <h4 class="card-title mb-4"><strong>ID: </strong><i>{{ questionario.id }}/{{ questionario.avaliacao.ano_exercicio }}</i></h4>
                <h4 class="card-title mb-4"><strong>AVALIAÇÃO: </strong><i>{{ questionario.entidade }}</i></h4>
                <h5 class="card-title mb-4"><strong>Avaliado por: </strong><i>{{ questionario.usuario.nome_completo }} ({{questionario.usuario.get_funcao_display}}) - {{ questionario.nota }} (Intermediário)</i></h5>
                <h5 class="card-title mb-4"><strong>Validado por:</strong><i> {{ questionario.validacao.usuario.nome_completo }} - {{ questionario.validacao.nota }} (Intermediário)</i></h5>

                {% if respostas %}

                <div id="accordion" class="custom-accordion">
                    {% for u in questionario.avaliacao.criterio_set.all  %}
                    {% ifchanged  %}
                    <div class="card mb-1 shadow-none">
                        <a href="#collapse{{ u.dimensao.id }}" class="text-dark" data-bs-toggle="collapse"
                                        aria-expanded="true"
                                        aria-controls="collapse{{ u.dimensao.id }}">
                            <div class="card-header" id="heading{{ u.dimensao.id }}">
                                <h6 class="m-0">
                                    {{ u.dimensao }}
                                    <i class="mdi mdi-minus float-end accor-plus-icon"></i>
                                </h6>
                            </div>
                        </a>

                        <div id="collapse{{ u.dimensao.id }}" class="collapse show"
                                aria-labelledby="headingOne" data-bs-parent="#accordion">
                            <div class="card-body">
                                {% for a in questionario.avaliacao.criterio_set.all %}
                                {% if a.dimensao == u.dimensao %}
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col-md-12">
                                                    <div class="card-body">
                                                        <h5 class="card-title">{{ a.id}} - {{ a.criterio_texto }} ({{ a.get_exigibilidade_display }})</h5>
                         
                                                        <footer class="blockquote-footer font-size-15 m-0">
                                                         Itens atendidos pela avaliação: <br>
                                                           {% for c in a.criterioitem_set.all %}
                                                                {% for r in c.resposta_set.all %}
                                                                {% if r.questionario.id == questionario.id %}
                                                                    {% if r.resposta == True %}
                                                                        <mark>{{c.item_avaliacao}}</mark>
                                                                    {% else %}
                                                                        <del>{{c.item_avaliacao}}</del>
                                                                    {% endif %}
                                                                {% endif %}
                                                                {% endfor %}
                                                            {% endfor %}

                                                            <p class="card-text">
                                                                <small >
                                                                {% for c in a.criterioitem_set.all %}
                                                                    {% for r in c.resposta_set.all %}
                                                                    {% if r.questionario.id == questionario.id %}
                                                                        {% for link in r.linkevidencia_set.all %}
                                                                            <a href="{{ link.link }}" target="_blank">{{ link.link }}</a>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                    {% endfor %}
                                                                {% endfor %}
                                                                </small>
                                                            </p>
                                                            <div class='input-group'>
                                                                {% for c in a.criterioitem_set.all %}
                                                                {% for r in c.resposta_set.all %}
                                                                {% if r.questionario.id == questionario.id %}
                                                                    {% for img in r.imagemevidencia_set.all %}
                                                                    {% if img.imagem %}
                                                                <div class="popup-gallery">
                                                                    <a class="float-start" href="{{ img.imagem.url }}" title="{{ img.imagem }}">
                                                                        <div class="img-fluid">
                                                                            <img width="80" src='{{ img.imagem.url }}' alt="Card image">
                                                                        </div>
                                                                    </a>
                                                                </div>
                                                                    {% endif %}
                                                                    {% endfor %}
                                                                {% endif %}
                                                                {% endfor %}
                                                                {% endfor %}
                                                               </div>
                                                        </footer>
                                                        <br>
                                                        <footer class="blockquote-footer font-size-15 m-0">
                                                            Itens atendidos pela validação do Tribunal: <br>
                                                              {% for c in a.criterioitem_set.all %}
                                                                   {% for r in c.respostavalidacao_set.all %}
                                                                   {% if r.resposta_validacao == True %}
                                                                        <mark>{{c.item_avaliacao}}</mark>
                                                                    {% else %}
                                                                        <del>{{c.item_avaliacao}}</del>
                                                                    {% endif %}
                                                                   {% endfor %}
                                                               {% endfor %}
   
                                                               <p class="card-text">
                                                                   <small >
                                                                   {% for c in a.criterioitem_set.all %}
                                                                       {% for r in c.respostavalidacao_set.all %}
                                                                           {% for link in r.linkevidenciavalidacao_set.all %}
                                                                               <a href="{{ link.link }}" target="_blank">{{ link.link_validacao }}</a>
                                                                           {% endfor %}
                                                                       {% endfor %}
                                                                   {% endfor %}
                                                                   </small>
                                                               </p>
                                                               <div class='input-group'>
                                                                {% for c in a.criterioitem_set.all %}
                                                                {% for r in c.resposta_set.all %}
                                                                {% for img in r.imagemevidenciavalidacao_set.all %}
                                                                {% if img.imagem %}
                                                                <div class="popup-gallery">
                                                                    <a class="float-start" href="{{ img.imagem_validacao.url }}" title="{{ img.imagem_validacao }}">
                                                                        <div class="img-fluid">
                                                                            <img width="80" src='{{ img.imagem_validacao.url }}' alt="Card image">
                                                                        </div>
                                                                    </a>
                                                                </div>
                                                                {% endif %}
                                                                {% endfor %}
                                                                {% endfor %}
                                                                {% endfor %}
                                                               </div>
                                                           </footer>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endifchanged %}
                    {% endfor %}
                </div>
                {% else %}

                <div class="alert alert-primary" role="alert">
                    Esta Unidade Gestora não possui avaliação do Controlador Interno.
                </div>

                {% endif %}
            </div>
        </div>
    <div>
</div> <!-- row end -->

{% block 'script' %}
        <!-- Magnific Popup-->
        <script src="{% static 'assets/libs/magnific-popup/jquery.magnific-popup.min.js' %}"></script>
        <!-- lightbox init js-->
        <script src="{% static 'assets/js/pages/lightbox.init.js' %}"></script>

{% endblock 'script' %}

{% endblock 'body' %}
